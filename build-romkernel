#!/bin/bash

# Gather parameters
function parse_parameters()
{
  while [[ "${#}" -ge 1 ]]; do
    case "${1}" in
      "-d"|"--device")
        shift && enforce_value "${@}"
        DEVICE="${1}" ;;

      "-r"|"--rom")
        shift && enforce_value "${@}"
        ROM="${1}" ;;

      "-g"|"--gdrive")
        export GDRIVE=true ;;

      "-tg"|"--telegram")
        export TELEGRAM=true ;;

      "-ak"|"--anykernel")
        ANYKERNEL=true ;;

      *) die "Invalid parameter specified!" ;;
    esac
    shift
  done

  # Default parameters
  [[ -z "${ROM}" ]] && ROM="abc"
  [[ -z "${DEVICE}" ]] && DEVICE="chiron"
}

# Build kernel image by using ROM sources
function buildromkernel() {
  # Small cleanup
  info "Removing old images..."
  rm -f "${BUILD_PATH}/{boot.img,kernel}"

  # Compilation
  info "Compiling boot and kernel images for ${DEVICE}..."
  mka bootimage 2>&1 | tee "${HOME}/logs/buildromkernel.log"

  # Export output image for anykernel2
  export COMPILED_IMAGE="${BUILD_PATH}/kernel"
}

# If anykernel is chosen we compress kernel image into Anykernel2 zip
# Otherwise we use bootimage as output for further commands
function choose_output() {
  if [[ -n "${ANYKERNEL}" ]]
  then
    ramdisk # Anykernel2 zipping
  else
    export OUTPUT="${BUILD_PATH}/boot.img"
  fi
}

#####################
##  RUN THEM ALL!  ##
#####################

# Common script
source "$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" || return; pwd)/common"

# Print formatted message about build start
startscript

# Parse parameters and setup enviroment
parse_parameters "${@}"
romenviroment

# Compile boot and kernel images
buildromkernel

# Choose which image to use as output one
choose_output

# Upload if needed
upload

# Print formatted message about script ending
endscript
